/*! Livetube Notifier v1.4.0 Github repo: https://github.com/sekai013/Livetube-Notifier */
"use strict";var APIs,Videos,checkNewVideos,createNotification,extractVideos,openVideos,sendVideosToPopup,storage,updateStatus,updateVideos;APIs=["http://livetube.cc/index.live.json","http://h.livetube.cc/index.live.json","http://t.livetube.cc/index.live.json","http://z.livetube.cc/index.live.json"],Videos=function(a){var b;return b=a||[],b.include=function(a){return this.some(function(b){return b.id===a.id?!0:void 0})},b},storage={},chrome.storage.sync.get("status",function(a){return storage.status=a}),chrome.storage.sync.get("words",function(a){return storage.words=a}),createNotification=function(a){var b,c,d;return d=a.title,c=a.message,b=a.clearIntervalInMSec,chrome.notifications.create("LTN_"+Date.now(),{type:"basic",iconUrl:"icons/icon128.png",title:d,message:c},function(a){return setTimeout(function(){return chrome.notifications.clear(a,function(){})},b)})},checkNewVideos=function(){var a;return a=new Videos,function(b){var c,d,e,f;for(c=new Videos,e=0,f=b.length;f>e;e++)d=b[e],a.include(d)||(c.push(d),createNotification({title:"New video has been started!",message:"新しい配信が開始しました: "+d.author+"/"+d.title,clearIntervalInMSec:4e3}));return a=b,c}}(),openVideos=function(a){var b,c,d,e,f;for(b=storage.status.status.useHServer===!0?"http://h.livetube.cc/":"http://livetube.cc/",f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(open(b+c.link,null));return f},extractVideos=function(a,b){var c,d,e,f,g,h,i,j;for(d=new Videos,c=[],g=0,i=a.length;i>g;g++)for(e=a[g],h=0,j=b.length;j>h;h++)if(f=b[h],-1!==e[f.type].indexOf(f.text)){d.push(e);break}return d},sendVideosToPopup=function(a){return chrome.runtime.sendMessage(chrome.runtime.id,{action:"updatePopup",videos:a}),chrome.browserAction.setBadgeText({text:a.length.toString()}),chrome.browserAction.setBadgeBackgroundColor({color:"#47A"})},updateVideos=function(){var a,b,c;return b=Math.floor(Math.random()*APIs.length),a=APIs[b],c=new XMLHttpRequest,c.open("GET",a,!0),c.onreadystatechange=function(){var a,b,d;return 4===c.readyState&&200===c.status&&(a=JSON.parse(c.responseText),b=extractVideos(a,storage.words.words),d=checkNewVideos(b),sendVideosToPopup(b),storage.status.status.autoOpen)?openVideos(d):void 0},c.send()},updateStatus=function(a,b,c){return null==c&&(c=function(){}),storage.status.status[a]=b,chrome.storage.sync.set(storage.status,c)},chrome.runtime.onMessage.addListener(function(a){var b;return b={updateVideos:function(){return updateVideos()},startGettingVideos:function(){return updateStatus("gettingVideos",!0,function(){return updateVideos(),chrome.alarms.create("updateVideos",{periodInMinutes:+storage.status.status.updateIntervalInMinutes}),createNotification({title:"Start Getting Videos!",message:"動画の取得を開始しました",clearIntervalInMSec:2e3})})},stopGettingVideos:function(){return updateStatus("gettingVideos",!1,function(){return chrome.alarms.clear("updateVideos",function(){return chrome.browserAction.setBadgeText({text:""}),createNotification({title:"Stop Getting Videos",message:"動画の取得を停止しました",clearIntervalInMSec:2e3})})})},updateStatus:function(){return updateStatus(a.property,a.newValue),storage.status.status.gettingVideos&&"updateIntervalInMinutes"===a.property?chrome.alarms.create("updateVideos",{periodInMinutes:+a.newValue}):void 0},registerWord:function(){return storage.words.words.push(a.word),chrome.storage.sync.set(storage.words,function(){})},deleteWord:function(){var b,c,d,e,f;for(f=storage.words.words,b=d=0,e=f.length;e>d;b=++d)if(c=f[b],c.id===a.id){storage.words.words.splice(b,1);break}return chrome.storage.sync.set(storage.words,function(){})}},a.action in b?b[a.action]():void 0}),chrome.alarms.onAlarm.addListener(function(a){var b;return b={updateVideos:function(){return updateVideos()}},a.name in b?b[a.name]():void 0}),chrome.runtime.onInstalled.addListener(function(){return chrome.storage.sync.get("state",function(a){var b;return b=a.state?{gettingVideos:a.state.gettingVideos,useHServer:a.state.h,autoOpen:a.state.autoOpen,updateIntervalInMinutes:a.state.intervalInMinutes}:{gettingVideos:!1,useHServer:!1,autoOpen:!1,updateIntervalInMinutes:5},a.status=b,chrome.storage.sync.set(a,function(){return chrome.storage.sync.remove("state"),storage.status=a})}),chrome.storage.sync.get("words",function(a){var b,c,d,e,f,g,h,i,j;if(g=[],a.words){j=a.words;for(e in j)for(d=j[e],b=h=0,i=d.length;i>h;b=++h)c=d[b],f={type:e,text:c,id:""+e+b},g.push(f)}return a.words=g,chrome.storage.sync.set(a,function(){return storage.words=a})})});